{% extends "core/base.html" %}
{% load crispy_forms_tags %}
{% block content %}
    <div class="content-section">
        <div class="media">
            <img class="rounded-circle account-img" src="{{ user.userprofile.picture.url }}">
            <div class="media-body">
                <h2 class="account-heading">{{ user.username }}</h2>
                <p id="p-name-id" class="text-secondary">{{ user.first_name }}</p>
                <p id="p-email-id" class="text-secondary">{{ user.email }}</p>
            </div>

        <!-- FORM HERE -->
    </div>
    <hr>
    {% include "accounts/modal_user_edit.html" %}
    <br />
    <br />
    {% include "accounts/modal_userprofile_edit.html" %}
    <br />
    <br />
    <a href="{% url 'password_change' %}">
        <button class="btn btn-secondary" type="submit">
            Change your password
        </button>
    </a>


    </div>
{% endblock content %}

{% block jquery %}
    <script>
        $(document).ready(function() {
            function clear_field(selector) {
                $(selector).text('')
            }
            function clear_html(selector) {
                $(selector).html('')
            }

             $("#password-change-form").submit(function (e) {
                e.preventDefault();
                var this_ = $(this),
                    formData = this_.serialize();
                $.ajax({
                    url: "/api/user/{{ user.id }}/",
                    data: formData,
                    method: "PATCH",
                    success: function (data) {
                        console.log(data);
                    },
                    error: function (data) {
                        console.log("error");
                        console.log(data.statusText);
                        console.log(data.status);
                        console.log(data)
                    }
                });
            });

            $("#user-edit-form").submit(function (e) {
                e.preventDefault();
                var this_ = $(this),
                    formData = this_.serialize(),
                    url = "/api/user/{{ user.id }}/";
                $.ajax({
                    url: url,
                    data: formData,
                    method: "PATCH",
                    success: function (data) {
                        console.log(data);
                        // clearing alert messages
                        clear_html("#email-edit-success");
                        clear_html("#email-edit-error");
                        // Alert success message
                        $("#email-edit-success").append('<div class="alert alert-success" role="alert">Your profile has been successfully updated!</div>');
                        ajax_get(url, change_profile_email);
                    },
                    error: function (data) {
                        console.log(data.responseText);
                        // clearing alert messages
                        clear_html("#email-edit-success");
                        clear_html("#email-edit-error");
                        // Alert error message
                        if (data.responseText === '{"email":["That email address is already taken."]}') {
                            $("#email-edit-error").append('<div class="alert alert-danger" role="alert">' + JSON.parse(data.responseText).email[0] + '</div>');
                        }

                    }
                });
            });
            $("#userprofile-edit-form").submit(function (e) {
                e.preventDefault();
                var formData = new FormData();
                formData.append( 'picture', ($(this).find('[type=file]')[0].files[0]));
                {#formData.append('_method', 'PATCH');#}
                $.ajax({
                    enctype: 'multipart/form-data',
                    url: "/api/profile/{{ user.userprofile.id }}/",
                    data: formData,
                    method: "PATCH",
                    processData: false,
                    contentType: false,
                    success: function (data) {
                        console.log(data);
                    },
                    error: function (data) {
                        console.log(data.statusText + " statusText");
                        console.log(data.status + " status");
                        console.log(data.responseText);
                    }
                });
            });
            $('#user-edit-id').click(function (e) {
                 e.preventDefault();
                var url = "/api/user/{{ user.id }}/";
                ajax_get(url, fill_edit_form);
                clear_html("#email-edit-success");
                clear_html("#email-edit-error");
            });

            function ajax_get(url, success_func) {
                $.ajax({
                    url: url,
                    method: "GET",
                    success: function(data){
                        console.log(data['first_name']);
                        console.log(data['email']);
                        success_func(data);
                    },
                    error: function(data){
                        console.log("error");
                        console.log(data);
                    }
                });
            }
            function fill_edit_form(data) {
                $("#id_first_name").val(data['first_name']);
                $("#id_email").val(data['email']);
            }

            function change_profile_email(data) {
                $("#p-email-id").text(data["email"]);
                $("#p-name-id").text(data["first_name"]);
            }
        });
    </script>
{% endblock jquery %}